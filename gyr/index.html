<!doctype html>
<html>

<head>
    <link rel="stylesheet" type="text/css" href="css/style.css">
    <script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>
    <script type="text/javascript" charset="utf-8" src="js/jquery-ui.js"></script>
    <script type="text/javascript" charset="utf-8" src="js/dYD.js"></script>
    <script type="text/javascript" charset="utf-8" src="js/fabric.min.js"></script>
    <script>
        $(function () {
            $("#images").accordion();
        });
    </script>
</head>

<body>
    <header>
        <h1><center>
            <img src="img/title.PNG"/>
        </center></h1>
    </header>
    <div id="canvas-container">
        <canvas id="c" width="600" height="600"></canvas>
    </div>
    <div id="draggable-menu-wrapper">
        <div id="images">
            <h2>Bed</h2>
            <div id="bed">
                <span><img class="item-thumbnail" src="img/bed01.png"/></span>
                <span><img class="item-thumbnail" src="img/bed02.jpg"/></span>
                <span><img class="item-thumbnail" src="img/bed03.jpg"/></span>
                <span><img class="item-thumbnail" src="img/bed04.jpg"/></span>
            </div>
            <h2>Seating</h2>
            <div id="seating">
                <span><img class="item-thumbnail" src="img/chair01.jpg"/></span>
                <span><img class="item-thumbnail" src="img/chair02.jpg"/></span>
                <span><img class="item-thumbnail" src="img/chair03.jpg"/></span>
                <span><img class="item-thumbnail" src="img/chair04.jpg"/></span>
            </div>
            <h2>Tables</h2>
            <div id="table">
                <span><img class="item-thumbnail" src="img/table01.png"/></span>
                <span><img class="item-thumbnail" src="img/table02.png"/></span>
                <span><img class="item-thumbnail" src="img/table03.png"/></span>
                <span><img class="item-thumbnail" src="img/table04.jpg"/></span>
            </div>
            <h2>Lighting</h2>
            <div id="lighting">
                <span><img class="item-thumbnail" src="img/lamp01.png"/></span>
                <span><img class="item-thumbnail" src="img/lamp02.png"/></span>
                <span><img class="item-thumbnail" src="img/lamp03.png"/></span>
                <span><img class="item-thumbnail" src="img/lamp04.png"/></span>
            </div>
        </div>
    </div>

    <script>
        var canvas = new fabric.Canvas('c', {
            selection: false
        });

        var grid = 50;
        for (var i = 0; i < (600 / grid); i++) {
            canvas.add(new fabric.Line([i * grid, 0, i * grid, canvas.height], {
                stroke: 'lightgray',
                selectable: false,
                hasControls: false,
                hoverCursor: 'default'
            }));
            canvas.add(new fabric.Line([0, i * grid, canvas.width, i * grid], {
                stroke: 'lightgray',
                selectable: false,
                hasControls: false,
                hoverCursor: 'default'
            }));
        }

        canvas.on('mouse:over', function (e) {
            var objs = canvas.getObjects();
            var mouse = canvas.getPointer(event.e);
            for (var i = objs.length; i > 23; i--) {
                if (e.target == objs[i]) {
                    showImageTools(e.target);
                }
            }
        });

        canvas.on('mouse:out', function (e) {
            $('#imageDialog').remove();
        });

        canvas.on('object:moving', function (e) {
            var obj = e.target;
            obj.set({
                left: Math.round(obj.left / grid) * grid,
                top: Math.round(obj.top / grid) * grid
            });
            obj.setCoords();
            if (obj.getBoundingRect().top < 0 || obj.getBoundingRect().left < 0) {
                obj.top = Math.max(obj.top, obj.top - obj.getBoundingRect().top);
                obj.left = Math.max(obj.left, obj.left - obj.getBoundingRect().left);
            }
            if (obj.getBoundingRect().top + obj.getBoundingRect().height > obj.canvas.height || obj.getBoundingRect().left + obj.getBoundingRect().width > obj.canvas.width) {
                obj.top = Math.min(obj.top, obj.canvas.height - obj.getBoundingRect().height + obj.top - obj.getBoundingRect().top);
                obj.left = Math.min(obj.left, obj.canvas.width - obj.getBoundingRect().width + obj.left - obj.getBoundingRect().left);
            }
        });

        function showImageTools(e) {
            if (!$('#imageDialog').length) {
                $('body').append("<div id='imageDialog' style='position: absolute; top: 0; left: 0; color: green' ><h1>Green Tips!</h1></div>");
            }
            moveImageTools(e);
        }

        function moveImageTools(e) {
            var w = $('#imageDialog').width();
            var h = $('#imageDialog').height();
            var coords = getObjPosition(e);
            console.log('coords', coords);
            var top = coords.bottom - h - 75;
            var left = coords.right - w + 35;
            $('#imageDialog').show();
            $('#imageDialog').css({
                top: top,
                left: left
            });
        }

        function getObjPosition(e) {
            var rect = e.getBoundingRect();
            var offset = canvas.calcOffset();
            var bottom = offset._offset.top + rect.top + rect.height;
            var right = offset._offset.left + rect.left + rect.width;
            var left = offset._offset.left + rect.left;
            var top = offset._offset.top + rect.top;
            return {
                left: left,
                top: top,
                right: right,
                bottom: bottom
            };
        }

        function handleDragStart(e) {
    [].forEach.call(images, function (img) {
                img.classList.remove('img_dragging');
            });
            this.classList.add('img_dragging');
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'copy';
            return false;
        }

        function handleDragEnter(e) {
            this.classList.add('over');
        }

        function handleDragLeave(e) {
            this.classList.remove('over');
        }

        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }

            var img = document.querySelector('#images img.img_dragging');
            var newImage = new fabric.Image(img, {
                width: 100,
                height: 100,
                left: e.layerX,
                top: e.layerY,
                hasControls: false,
                hasBorders: false
            });

            /*            var seat = document.querySelector('#seating img.img_dragging');
                        var newImage1 = new fabric.Image(seat, {
                            width: 50,
                            height: 50,
                            left: e.layerX,
                            top: e.layerY,
                            hasControls: false,
                            hasBorders: false
                        });

                        var table = document.querySelector('#table img.img_dragging');
                        var newImage2 = new fabric.Image(table, {
                            width: 100,
                            height: 50,
                            left: e.layerX,
                            top: e.layerY,
                            hasControls: false,
                            hasBorders: false
                        });

                        var lighting = document.querySelector('#lighting img.img_dragging');
                        var newImage3 = new fabric.Image(lighting, {
                            width: 50,
                            height: 50,
                            left: e.layerX,
                            top: e.layerY,
                            hasControls: false,
                            hasBorders: false
                        });*/

            canvas.add(newImage);
            /*canvas.add(newImage1);
            canvas.add(newImage2);
            canvas.add(newImage3);*/

            return false;
        }

        function handleDragEnd(e) {
    [].forEach.call(images, function (img) {
                img.classList.remove('img_dragging');
            });
        }

        var images = document.querySelectorAll('#images img');
    [].forEach.call(images, function (img) {
            img.addEventListener('dragstart', handleDragStart, false);
            img.addEventListener('dragend', handleDragEnd, false);
        });
        var canvasContainer = document.getElementById('canvas-container');
        canvasContainer.addEventListener('dragenter', handleDragEnter, false);
        canvasContainer.addEventListener('dragover', handleDragOver, false);
        canvasContainer.addEventListener('dragleave', handleDragLeave, false);
        canvasContainer.addEventListener('drop', handleDrop, false);

        canvas.on('object:selected', function (e) {

            $('#imageDialog').remove();
            jQuery(".deleteBtn").remove();
            var btnLeft = e.target.oCoords.mt.x;
            var btnTop = e.target.oCoords.mt.y - 25;
            var widthadjust = e.target.width / 2;
            btnLeft = widthadjust + btnLeft - 10;
            var deleteBtn = '<p" class="deleteBtn" title="Remove" style="position:absolute;top:' + btnTop + 'px;left:' + btnLeft + 'px;cursor:pointer;" title="Remove object">&#10005;</p>';
            jQuery(".canvas-container").append(deleteBtn);
        });

        canvas.on('mouse:down', function (e) {
            if (canvas.getActiveObject()) {

            } else {
                jQuery(".deleteBtn").remove();
            }
        });

        canvas.on('object:modified', function (e) {
            jQuery(".deleteBtn").remove();
            var btnLeft = e.target.oCoords.mt.x;
            var btnTop = e.target.oCoords.mt.y - 25;
            var widthadjust = e.target.width / 2;
            btnLeft = widthadjust + btnLeft - 10;
            var deleteBtn = '<p" class="deleteBtn" title="Remove" style="position:absolute;top:' + btnTop + 'px;left:' + btnLeft + 'px;cursor:pointer;" title="Remove object">&#10005;</p>';
            jQuery(".canvas-container").append(deleteBtn);
        });

        canvas.on('object:moving', function (e) {
            jQuery(".deleteBtn").remove();
        });

        jQuery(document).on('click', ".deleteBtn", function () {
            if (canvas.getActiveObject()) {
                canvas.remove(canvas.getActiveObject());
                jQuery(this).remove();
                jQuery(".deleteBtn").remove();
            }
        });
    </script>
</body>

</html>